# reusable workflow
name: Run E2E tests in local environment

on:
  workflow_call:
    inputs:
      api-image:
        type: string
        description: API image to use
        required: true
      tests:
        type: string
        description: Space-delimited list of E2E tests to be executed
        required: false
        default: ''
      concurrency:
        type: number
        description: The concurrent number of browsers to be used on testing
        required: false
        default: 3

jobs:
  run-e2e:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:11.12-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: flagsmith
        ports: ['5432:5432']
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Cloning repo
        uses: actions/checkout@v4

      - name: Run Local API
        id: run-local-api
        uses: ./.github/actions/run-local-api
        with:
          api-image: ${{ inputs.api-image }}
          e2e_test_token: some-token
          # As per https://stackoverflow.com/q/65497331/421808 172.17.0.1 seems like the only way to resolve host DB
          database_url: postgres://postgres:postgres@172.17.0.1:5432/flagsmith
          disable_analytics_features: true

      - name: Run E2E tests against local
        uses: ./.github/actions/e2e-tests
        env:
          E2E_CONCURRENCY: ${{ inputs.concurrency }}
        with:
          e2e_test_token: some-token
          slack_token: ${{ secrets.SLACK_TOKEN }}
          environment: local
          tests: ${{ inputs.tests }}

      - name: Output API container status and logs
        if: failure()
        env:
          API_CONTAINER_ID: ${{ steps.run-local-api.outputs.containerId }}
        run: |
          docker inspect $API_CONTAINER_ID | jq '.[0].State'
          docker logs $API_CONTAINER_ID
        shell: bash
